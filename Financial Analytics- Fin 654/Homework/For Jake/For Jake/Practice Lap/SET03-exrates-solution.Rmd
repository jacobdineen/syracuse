---
title: "Practice Set #3"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[CO,CE]{\thetitle}
- \fancyfoot[CO,CE]{Copyright 2016 William G. Foote}
- \fancyhead[RE,RO]{\thepage}
- \renewcommand{\footrulewidth}{0.5pt}
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=36))
knitr::opts_chunk$set(size = "small")
knitr::opts_hooks$set(fig.width = function(options) {
  if (options$fig.width < options$fig.height) {
    options$fig.width = options$fig.height
  }
  options
})
knitr::knit_hooks$set(mysize = function(before, options, envir) {
  if (before) 
    return(options$size)
})
```

## Purpose, Process, Product

Various `R` features and finance topics will be reprised in this chapter. Specifically we will practice reading in data, exploring time series, estimating auto and cross correlations, and investigating volatility clustering in financial time series. We will summarize our experiences in debrief. 

### Set A

In this set we will build and explore a data set using filters and `if` and `diff` statements. We will then answer some questions using plots and a pivot table report. We will then review a function to house our approach in case we would like to run some of the same analysis on other data sets.

#### Problem

Marketing and accounts receivableds managers at our company continue to note we have a significant exposure to exchange rates. Our customer base is located in the United Kingdom, across the European Union, and in Japan. The exposure hits the gross revenue line of our financials. Cash flow is further affected by the ebb and flow of accounts receivable components of working capital. of producing several products. When exchange rates are volatile, so is earnings, and more importantly, our cash flow. Our company has also missed earnings forecasts for five straight quarters. To get a handle on exchange rate exposures we download this data set and review some basic aspects of the exchange rates. 

```{r }
# Read in data
require(zoo)
require(xts)
require(ggplot2)
# Read and review a csv file from FRED
exrates <- na.omit(read.csv("data/exrates.csv", header = TRUE))
head(exrates)
tail(exrates)
str(exrates)
```

#### Questions

1. What is the nature of exchange rates? We want to reflect the ups and downs of rate movements, known to managers as currency appreciation and depreciation. First, we calculate percentage changes as log returns. Our interest is in the ups and downs. To look at that we use `if` and `else` statements to define a new column called `direction`. We will build a data frame to house this analysis.
```{r }
# Compute log differences percent using as.matrix to force numeric type
exrates.r <- diff(log(as.matrix(exrates[, -1]))) * 100
head(exrates.r)
tail(exrates.r)
str(exrates.r)
# Create size and direction
size <- na.omit(abs(exrates.r)) # size is indicator of volatility
colnames(size) <- paste(colnames(size),".size", sep = "")
direction <- ifelse(exrates.r > 0, 1, ifelse(exrates.r < 0, -1, 0)) # another indicator of volatility
colnames(direction) <- paste(colnames(direction),".dir", sep = "")
# Convert into a time series object: 
# 1. Split into date and rates
dates <- as.Date(exrates$DATE[-1], "%m/%d/%Y")
values <- cbind(exrates.r, size, direction)
# for dplyr pivoting we need a data frame
exrates.df <- data.frame(dates = dates, returns = exrates.r, direction = direction)
str(exrates.df) # notice the returns.* and direction.* prefixes
# 2. Make an xts object with row names equal to the dates
exrates.xts <- na.omit(as.xts(values, dates)) #order.by=as.Date(dates, "%d/%m/%Y")))
str(exrates.xts)
exrates.zr <- as.zooreg(exrates.xts)
str(exrates.zr)
```

We can plot with the `ggplot2` package. In the `ggplot` statements we use `aes`, "aesthetics", to pick `x` (horizontal) and `y` (vertical) axes. Use `group =1` to ensure that all data is plotted. The added (`+`) `geom_line` is the geometrical method that builds the line plot.
```{r }
require(ggplot2)
title.chg <- "Exchange Rate Percent Changes"
autoplot.zoo(exrates.xts[,1:4]) + ggtitle(title.chg) + ylim(-5, 5)
``` 

2. Let's dig deeper and compute mean, standard deviation, etc. Load the `data_moments()` function. Run the function using the `HO2.df$return` subset and write a `knitr::kable()` report.
```{r }
acf(coredata(exrates.xts[,1:4]))
acf(coredata(exrates.xts[,5:7]))
# Load the data_moments() function
## data_moments function
## INPUTS: r vector
## OUTPUTS: list of scalars (mean, sd, median, skewness, kurtosis)
data_moments <- function(data){
  require(moments)
  mean.r <- mean(data)
  sd.r <- sd(data)
  median.r <- median(data)
  skewness.r <- skewness(data)
  kurtosis.r <- kurtosis(data)
  result <- data.frame(mean = mean.r, std_dev = sd.r, median = median.r, skewness = skewness.r, kurtosis = kurtosis.r)
  return(result)
}
# Run data_moments()
answer <- data_moments(exrates.xts)
# Build pretty table
answer <- round(answer, 4)
knitr::kable(answer)
```

### Set B

We will use the data from Set A to investigate the interactions of the distribution of exchange rates.

#### Problem

We want to characterize the distribution of up and down movements visually. Also we would like to repeat the analysis periodically for inclusion in management reports.

#### Questions 
1. How can we show the shape of our exposure to euros, especially given our tolerance for risk? Suppose corporate policy set tolerance at 95\%. Let's use the `exrates.df` data frame with `ggplot2` and the cumulative relative frequency function `stat_ecdf`.
```{r }
exrates.tol.pct <- 0.95
exrates.tol <- quantile(exrates.df$returns.USD.EUR, exrates.tol.pct)
exrates.tol.label <- paste("Tolerable Rate = ", round(exrates.tol, 2), "%", sep = "")
ggplot(exrates.df, aes(returns.USD.EUR, fill = direction.USD.EUR.dir)) + stat_ecdf(colour = "blue", size = 0.75) + geom_vline(xintercept = exrates.tol, colour = "red", size = 1.5) + annotate("text", x = exrates.tol + 1 , y = 0.75, label = exrates.tol.label, colour = "darkred")
```

2. What is the history of correlations in the exchange rate markets? If this is a "history," then we have to manage the risk that conducting business in one country will definitely affect business in another. Further that bad things will be followed by more bad things more often than good things. We will create a rolling correlation function, `corr.rolling`, and embed this function into the `rollapply()` function (look this one up!).

```{r }
ccf(exrates.zr[, 1], exrates.zr[, 2], main = "GBP vs. EUR", lag.max = 20, ylab = "", xlab = "", col = "blue", ci.col = "red")	
ccf(abs(exrates.zr[, 1]), abs(exrates.zr[, 2]), main = "GBP vs. EUR: size", lag.max = 20, ylab = "", xlab = "", col = "blue", ci.col = "red")		
#' We see some small raw correlations across time with raw returns. More revealing, we see volatility of correlation clustering using return sizes. One more experiment: a rolling correlation using this function:	
#' 	
#' 	
corr.rolling <- function(x) {	
  dim <- ncol(x)	
  corr.r <- cor(x)[lower.tri(diag(dim), diag = FALSE)]	
  return(corr.r)	
}
ALL.r <- exrates.zr[, 1:4]
corr.returns <- rollapply(ALL.r, width = 250, corr.rolling, align = "right", by.column = FALSE)
head(corr.returns)
str(corr.returns)
colnames(corr.returns) <- c("EUR & GBP", "EUR & CNY", "EUR & JPY", "GBP & CNY", "GBP & JPY", "CNY & JPY")	
plot(corr.returns, xlab = "", main = "")	
#' 	

```

4. How related are correlations and volatilities? Put another way, do we have to be concerned that inter-market transactions (e.g., customers and vendors transacting in more than one currency) can affect transactions in a single market? Let's take the `exrate` data to understand how dependent correlations and volatilities depend upon one another.

```{r}
require(matrixStats)
R.corr <- apply.monthly(as.xts(ALL.r), FUN = cor)	
str(R.corr)
head(ALL.r)
head(R.corr)
R.vols <- apply.monthly(ALL.r, FUN = colSds) # from MatrixStats	
head(R.corr, 3)	
head(R.vols, 3)	
#
# Form correlation matrix for one month 	
R.corr.1 <- matrix(R.corr[1,], nrow = 4, ncol = 4, byrow = FALSE)	
rownames(R.corr.1) <- colnames(ALL.r[,1:4])	
colnames(R.corr.1) <- rownames(R.corr.1)	
head(R.corr.1)	
#
R.corr <- R.corr[, c(2, 3, 4, 7, 8, 12)]	
head(R.corr)
colnames(R.corr) <- colnames(corr.returns) 	
colnames(R.vols) <- c("EUR.vols", "GBP.vols", "CNY.vols", "JPY.vols")	
head(R.corr, 3)	
head(R.vols, 3)	
R.corr.vols <- merge(R.corr, R.vols)
head(R.corr.vols)
#'
plot.zoo(R.corr.vols)	
#' 	
EUR.vols <- as.numeric(R.corr.vols[,"EUR.vols"])	
GBP.vols <- as.numeric(R.vols[,"GBP.vols"])	
CNY.vols <- as.numeric(R.vols[,"CNY.vols"])	
length(EUR.vols)	
#' 	
#' Smooth data volatility
#'
fisher <- function(r)	
{0.5 * log((1 + r)/(1 - r))}	
rho.fisher <- matrix(fisher(as.numeric(R.corr.vols[,1:6])), nrow = length(EUR.vols), ncol = 6, byrow= FALSE)	
#' 	
#' 	
#' ***	
#' Here is the quantile regression part of the package.	
#' 	
#' ## Notice	
#' 1. We set `taus` as the quantiles of interest.	
#' 2. We run the quantile regression using the `quantreg` package and a call to the `rq` function.	
#' 3. We can overlay the quantile regression results onto the standard linear model regression.	
#' 4. We can sensitize our analysis with the range of upper and lower bounds on the parameter estimates of the relationship between correlation and volatility.	
#' 	
#'
require(quantreg)
taus <- seq(.05,.95,.05)	
fit.rq.EUR.GBP <- rq(rho.fisher[,1] ~ EUR.vols, tau = taus)	
fit.lm.EUR.GBP <- lm(rho.fisher[,1] ~ EUR.vols)	
#' 	
summary(fit.rq.EUR.GBP, se = "boot")
#'
summary(fit.lm.EUR.GBP, se = "boot")
plot(summary(fit.rq.EUR.GBP), parm = "EUR.vols")	
#' ***	
#' Here we build the estimations and plot the upper and lower bounds.	
#' 	
taus1 <- c(.05, 0.5, .95) # fit the confidence interval (CI)
EUR.GBP.p <- predict(rq(rho.fisher[,1] ~ EUR.vols, tau = taus1))
EUR.GBP.lm.p <- predict(lm(rho.fisher[,1] ~ EUR.vols))
colnames(EUR.GBP.p) <- c(paste("tau",taus1[1]*100, sep = ""), paste("tau",taus1[2]*100, sep = ""), paste("tau",taus1[3]*100, sep = ""))
head(EUR.GBP.p)
EUR.GBP.CI <- data.frame(x = EUR.vols, y = rho.fisher[, 1], y.5 = EUR.GBP.p[, 1],  y.50 = EUR.GBP.p[, 2], y.95 = EUR.GBP.p[, 3], y.lm <- EUR.GBP.lm.p )
head(EUR.GBP.CI)
ggplot(EUR.GBP.CI, aes(x, y)) +
    geom_point() +
    geom_line(aes(y = y.5), colour = "red", linetype = "dashed") +
    geom_line(aes(y = y.95), colour = "red", linetype = "dashed") +
    geom_line(aes(y = y.50), colour = "blue") +
    geom_line(aes(y = y.lm), colour = "blue", linetype = "dashed")
```
	


### Practice Set Debrief

1. List the R skills needed to complete these practice sets.

2. What are the packages used to compute and graph results. Explain each of them.

3. How well did the results begin to answer the business questions posed at the beginning of each practice set?
